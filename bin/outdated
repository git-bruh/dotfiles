#!/bin/sh -e

IFS=", "

version_list() {
    for ver in $1; do
        echo "$ver"
    done
}

for pkg in ./*; do
    if [ -f "$pkg/version" ] && [ ! -h "$pkg/version" ]; then
        current_ver="$(awk '{print $1}' "$pkg/version")"
        url="https://repology.org/badge/latest-versions/${pkg}.svg"
        resp=$(curl -Ss "$url") && {
            remote_ver=${resp%</text>*}
            remote_ver=${remote_ver##*>}

            any_match=

            for ver in $remote_ver; do
                [ "$current_ver" = "$ver" ] && {
                    any_match=1
                    break
                }
            done

            [ "$any_match" ] || {
                printf "%s:\n\tCurrent: %s\n\tRemote: %s\n\n" \
                    "$pkg" "$current_ver" "$remote_ver"

                new_ver="$(version_list "$remote_ver" | bemenu)" || {
                    continue
                }

                (
                    cd "$pkg"

                    echo "$new_ver 1" > version
                    kiss checksum
                )
            }
        }
    fi
done
